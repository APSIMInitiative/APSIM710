<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="Build.xsl"?>

<!--
    This is the Job Scheduler file that Bob uses. It loads
	Build.xml to perform the build and run and then compresses the %apsim% directory, creates a 
	binary zip file and sends an email.
	
-->
<Folder name="Bob" LoopForever="no">

	<Job name="SVN revert">
		<WorkingDirectory>%apsim%</WorkingDirectory>
		<CommandLine>svn.exe revert -R %APSIM%</CommandLine>
	</Job>

	<Job name="SVN update" wait="yes">
		<WorkingDirectory>%apsim%</WorkingDirectory>
		<CommandLine>svn.exe update %APSIM%</CommandLine>
	</Job>
	
	<Job name="Remove unwanted files">
		<WorkingDirectory>%apsim%\Model</WorkingDirectory>
		<CommandLine>RunTime\cscs Build\RemoveUnwantedFiles.cs %APSIM%</CommandLine>
	</Job>
	
	<Folder name="BuildAndRun" wait="yes">
			<!--
		Get the APSIM directory up to date and clean.
		-->

		<Job name="Apply patch">
			<WorkingDirectory>%apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerApplyPatch.exe %APSIM% "C:\inetpub\wwwroot\Files\Upload\%PatchFileName%.zip" </CommandLine>
		</Job>
	
		<Job name="Copy RunTime DLL's into model directory" wait="yes">
			<WorkingDirectory>%Apsim%/Model/RunTime</WorkingDirectory>
			<CommandLine>..\Build\RunMake.bat %Apsim%/Model/RunTime</CommandLine>
		</Job>
		<Job name="Remove all .out and .sum files from Examples folder" wait="yes">
			<WorkingDirectory>%Apsim%\Examples</WorkingDirectory>
			<CommandLine>%Apsim%\Model\Build\RemoveOutAndSumFiles.bat</CommandLine>
		</Job>
		<Job name="Remove all .out and .sum files from Tests folder">
			<WorkingDirectory>%Apsim%\Tests</WorkingDirectory>
			<CommandLine>%Apsim%\Model\Build\RemoveOutAndSumFiles.bat</CommandLine>
		</Job>		
		<Job name="Delete the apsim.xml file in Bobs profile">
			<WorkingDirectory>%Apsim%\Model\Build</WorkingDirectory>
			<CommandLine>DeleteFileIfExists.bat %APPDATA%\Apsim</CommandLine>
		</Job>
		<!--
		Build APSIM
		-->

		<Job name="Load in Build.xml">
			<WorkingDirectory>%apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendCommand.exe "AddXMLFile~%JobPath%/../Build~%apsim%\Model\Build\BuildAll.xml"</CommandLine>
		</Job>
		<Folder name="Build" wait="yes"/>

			<!--
		Run all APSIM tests
		-->

		<Job name="Load in Run.xml">
			<WorkingDirectory>%apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendCommand.exe "AddXMLFile~%JobPath%/../Run~%apsim%\Model\Build\RunAll.xml"</CommandLine>
		</Job>
		<Folder name="Run" wait="yes"/>
	</Folder>
	
	<Folder name="Look for diffs"  wait="yes" IgnoreErrors="yes">
		<Job name="JobSchedulerCreateDiffZip"  wait="yes" IgnoreErrors="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerCreateDiffZip.exe %Apsim% C:\inetpub\wwwroot\Files\Upload\%PatchFileName%.zip</CommandLine>
		</Job>	
		
			<!--
		Build APSIM Documentation
		-->	

		<Folder name="Plant2 Documentation" wait="yes">
			<Job name="Create Broccoli Documentation">
				<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
				<CommandLine>Plant2Documentation.exe Broccoli.xml "%Apsim%\Documentation\4 Module Reference\Broccoli.htm"</CommandLine>
			</Job>
			<Job name="Create Vine Documentation">
				<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
				<CommandLine>Plant2Documentation.exe Vine.xml "%Apsim%\Documentation\4 Module Reference\Vine.htm"</CommandLine>
			</Job>
			<Job name="Create documentation">
				<WorkingDirectory>%Apsim%\Documentation</WorkingDirectory>
				<CommandLine>CreateIndex.bat</CommandLine>
			</Job> 	
		</Folder>

			<!--
		Build APSIM Release
		-->	

		<Folder name="Release" wait="yes">
			<Job name="Load in Release.xml">
				<WorkingDirectory>%apsim%\Release</WorkingDirectory>
				<CommandLine>%Apsim%\Model\JobSchedulerSendCommand.exe "AddXMLFile~%JobPath%/../Release~%apsim%\Release\Release.xml"</CommandLine>
			</Job>
			<Folder name="Release" wait="yes"/>		
		</Folder>
	
	</Folder>
	
		<!--
    Finish up by creating various zip files and updating database
	-->	

	<Folder name="WrapUp"  wait="yes" IgnoreErrors="yes">
		<Job name="CreateBuildTreeZip">
			<WorkingDirectory>C:\inetpub\wwwroot\Files</WorkingDirectory>
			<CommandLine>"C:\Program Files\7-Zip\7z.exe" -xr!.svn a -mx=7 -mmt=on %PatchFileName%.zip %Apsim% > nul</CommandLine>
		</Job>	
		<Job name="Update DB Build tree" wait="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerUpdateFieldInDB.exe BuildTreeFileName http://bob.apsim.info/files/%PatchFileName%.zip</CommandLine>
		</Job>					
		<Job name="CreateBinariesZip">
			<WorkingDirectory>C:\inetpub\wwwroot\Files</WorkingDirectory>
			<CommandLine>"C:\Program Files\7-Zip\7z.exe" a -mx=9 -mmt=on %PatchFileName%.binaries.zip %Apsim%\Model\*.exe %Apsim%\Model\*.dll > nul</CommandLine>
		</Job>		
		<Job name="Update DB Binaries" wait="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerUpdateFieldInDB.exe BinariesFileName http://bob.apsim.info/files/%PatchFileName%.binaries.zip</CommandLine>
		</Job>	
		<Job name="Do commit if clean" wait="yes" IgnoreErrors="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerIfCleanDoCommit.exe %Apsim% C:\inetpub\wwwroot\Files\Upload\%PatchFileName%.zip</CommandLine>
		</Job>	
	</Folder>

	<Folder name="Final jobs that should always run" wait="yes" IgnoreErrors="yes">
		<Job name="Update DB Details">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerUpdateFieldInDB.exe DetailsFileName http://bob.apsim.info/files/%PatchFileName%.xml</CommandLine>
		</Job>		
		<Job name="CreateSummaryHtml" wait="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerCreateSummaryHtml.exe %Apsim%</CommandLine>
		</Job>		
		<Job name="Send email" wait="yes" IgnoreErrors="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendEmail.exe @Build\MailList.txt</CommandLine>
		</Job>
		<Job name="Save the XML to a file" wait="yes" IgnoreErrors="yes">
			<WorkingDirectory>%apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendCommand.exe "AddVariable~OutputFileName~C:\inetpub\wwwroot\Files\%PatchFileName%.xml"</CommandLine>
		</Job>
	</Folder>
</Folder>