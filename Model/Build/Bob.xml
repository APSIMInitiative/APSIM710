<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="Build.xsl"?>

<!--
    This is the Job Scheduler file that Bob uses. It cleans the %apsim% directory, loads
	Build.xml to perform the build and run and then compresses the %apsim% directory, creates a 
	binary zip file and sends an email.
	
	NB: If you run this on your computer, it will clean out all unversioned files from your %apsim%
	    directory and revert all changes to SVN.
		i.e. YOU MAY LOSE YOUR WORK !!!!!!!!

-->
<Folder name="Bob" LoopForever="no">

	<Folder name="BuildAndRun" wait="yes">
		<!--
    Get the APSIM directory up to date and clean.
	-->

		<Job name="JobSchedulerWaitForPatch">
			<WorkingDirectory>%Apsim%</WorkingDirectory>
			<CommandLine>%Apsim%\Model\JobSchedulerWaitForPatch.exe C:\Upload</CommandLine>
		</Job>
		<Job name="SVN Revert"  wait="yes">
			<WorkingDirectory>%Apsim%</WorkingDirectory>
			<CommandLine>svn.exe revert -R %Apsim%</CommandLine>
		</Job>
		<Job name="SVN Update"  wait="yes">
			<WorkingDirectory>%Apsim%</WorkingDirectory>
			<CommandLine>svn.exe update %Apsim%</CommandLine>
		</Job>	
		<Job name="Remove unversioned files"  wait="yes">
			<WorkingDirectory>%Apsim%</WorkingDirectory>
			<CommandLine>%Apsim%\Model\RemoveUnversionedFiles.exe %Apsim%</CommandLine>
		</Job>
		<Job name="Apply patch"  wait="yes">
			<WorkingDirectory>%Apsim%</WorkingDirectory>
			<CommandLine>%Apsim%\..\BuildLibraries\Pat-ch.exe -p0 -i "C:\Upload\%PatchFileName%.patch"</CommandLine>
		</Job>
		<Job name="Remove all .out and .sum files" wait="yes">
			<WorkingDirectory>%Apsim%\Model\Build</WorkingDirectory>
			<CommandLine>RemoveOutAndSumFiles.bat</CommandLine>
		</Job>
		<Job name="Delete the apsim.xml file in Bobs profile">
			<WorkingDirectory>%Apsim%\Model\Build</WorkingDirectory>
			<CommandLine>DeleteFileIfExists.bat %APPDATA%\Apsim</CommandLine>
		</Job>
		<Job name="Write potential revision number into Apsim.xml">
			<WorkingDirectory>%Apsim%\Model\Build</WorkingDirectory>
			<CommandLine>%Apsim%\..\BuildLibraries\Tcl\ASTcl\bin\tclsh.exe WriteVersionNumberBob.tcl</CommandLine>
		</Job>

		<!--
    Build APSIM
	-->

		<Job name="Load in Build.xml">
			<WorkingDirectory>%apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendCommand.exe "AddXMLFile~%JobPath%/../Build~%apsim%\Model\Build\BuildAll.xml"</CommandLine>
		</Job>
		<Folder name="Build" wait="yes"/>

		<!--
    Run all APSIM tests
	-->

		<Job name="Load in Run.xml">
			<WorkingDirectory>%apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendCommand.exe "AddXMLFile~%JobPath%/../Run~%apsim%\Model\Build\RunAll.xml"</CommandLine>
		</Job>
		<Folder name="Run" wait="yes"/>

		<!--
    Build APSIM Documentation
	-->	

		<Folder name="Plant2 Documentation" wait="yes">
			<Job name="Create Broccoli Documentation">
				<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
				<CommandLine>Plant2Documentation.exe Broccoli.xml "%Apsim%\Documentation\4 Module Reference\Broccoli.htm"</CommandLine>
			</Job>
			<Job name="Create Vine Documentation">
				<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
				<CommandLine>Plant2Documentation.exe Vine.xml "%Apsim%\Documentation\4 Module Reference\Vine.htm"</CommandLine>
			</Job>
			<Job name="Create documentation">
				<WorkingDirectory>%Apsim%\Documentation</WorkingDirectory>
				<CommandLine>CreateIndex.bat</CommandLine>
			</Job> 	
		</Folder>

		<!--
    Build APSIM Release
	-->	

		<Folder name="Release" wait="yes">
			<Job name="Create release">
				<WorkingDirectory>%Apsim%\Release</WorkingDirectory>
				<CommandLine>Release.bat %PatchFileName%</CommandLine>
			</Job>	
			<Job name="Update DB Setup" wait="yes">
				<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
				<CommandLine>JobSchedulerUpdateFieldInDB.exe SetupFileName http://bob.apsim.info/files/%PatchFileName%.apsimsetupforrelease.exe</CommandLine>
			</Job>
			<Job name="Update DB Setup">
				<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
				<CommandLine>JobSchedulerUpdateFieldInDB.exe SetupForReleaseFileName http://bob.apsim.info/files/%PatchFileName%.apsimsetup.exe</CommandLine>
			</Job>	
		</Folder>

		<Job name="CreateBuildTreeZip">
			<WorkingDirectory>C:\inetpub\wwwroot\Files</WorkingDirectory>
			<CommandLine>"C:\Program Files\7-Zip\7z.exe" a -mx=9 -mmt=on %PatchFileName%.zip %Apsim% > nul</CommandLine>
		</Job>	
		<Job name="Update DB Build tree" wait="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerUpdateFieldInDB.exe BuildTreeFileName http://bob.apsim.info/files/%PatchFileName%.zip</CommandLine>
		</Job>		
		<Job name="CreateBinariesZip">
			<WorkingDirectory>C:\inetpub\wwwroot\Files</WorkingDirectory>
			<CommandLine>"C:\Program Files\7-Zip\7z.exe" a -mx=9 -mmt=on %PatchFileName%.binaries.zip %Apsim%\Model\*.exe %Apsim%\Model\*.dll > nul</CommandLine>
		</Job>		
		<Job name="Update DB Binaries" wait="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerUpdateFieldInDB.exe BinariesFileName http://bob.apsim.info/files/%PatchFileName%.binaries.zip</CommandLine>
		</Job>		
	</Folder>

		<!--
    Finish up by collecting diffs and sending the email.
	-->	

	<Folder name="WrapUp"  wait="yes" IgnoreErrors="yes">
		<Job name="CreateDiffsZip">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerCreateDiffZip.exe %Apsim% %PatchFileName%</CommandLine>
		</Job>
		<Job name="CreateSummaryHtml" wait="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerCreateSummaryHtml.exe %Apsim%</CommandLine>
		</Job>		
		<Job name="Do commit if clean" wait="yes" IgnoreErrors="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerIfCleanDoCommit.exe %Apsim% %PatchFileName%</CommandLine>
		</Job>			
	</Folder>

	<Folder name="Final jobs that should always run" wait="yes" IgnoreErrors="yes">
		<Job name="Update DB Details">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerUpdateFieldInDB.exe DetailsFileName http://bob.apsim.info/files/%PatchFileName%.diffs.zip</CommandLine>
		</Job>		
		<Job name="Send email" wait="yes" IgnoreErrors="yes">
			<WorkingDirectory>%Apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendEmail.exe @Build\MailList.txt</CommandLine>
		</Job>
		<Job name="Save the XML to a file" wait="yes" IgnoreErrors="yes">
			<WorkingDirectory>%apsim%\Model</WorkingDirectory>
			<CommandLine>JobSchedulerSendCommand.exe "SaveXMLToFile~C:\inetpub\wwwroot\Files\%PatchFileName%.xml"</CommandLine>
		</Job>
	</Folder>
</Folder>